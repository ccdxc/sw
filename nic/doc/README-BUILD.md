1.0: Introduction
=================
This make infra is built using non-recursive make. It reads all the 'module*.mk' from the TOPDIR(see below) and generates build rules.

1.1: Directory Layout of Infra
------------------------------
<ws>/sw/nic/sdk/mkinfra/*   : Core Make Infra
<ws>/sw/nic/mkdefs/*        : NIC Specific defines and targets.

2.0: Usage
==========
Each source directory will have one 'module.mk', that specifies the target to be built. Infra generates recipes for these targets based on the extension of the target name.
E.g. hal.bin will trigger compilation and linking.

Following sections cover the variables available in 'module.mk' to control this build process.

2.1: Pre-set Variables in module.mk
---------------------------------------------
TOPDIR              : Points to the top-level 'sw' directory
NICDIR              : Points to 'nic' directory
SDKDIR              : Points to 'sdk' directory
MKINFRA             : Points to 'sdk/mkinfra' directory
MKDEFS              : Points to 'nic/mkdefs' directory
MODULE_DIR          : Directory of the 'module.mk'. 
                      Note: '.' always points to 'sw/nic' directory
MODULE_SRC_DIR      : Directory of the 'module.mk'. 
                      All the source files will be read from this directory.
MODULE_EXPORT_DIR   : (Applicable only for export targets) 
                      Directory for the files to be exported. Default is ${MODULE_DIR}/${ARCH}

2.2: User Variables in module.mk:
====================================
MODULE_TARGET: Defines a build target. The extension of this target will be 
               used to generate build rules. 
               
               Following are the supported extensions,
               .so     : Builds a shared library using '.cc' or '.c' files.
               .a      : Builds an archive library using '.cc' or '.c' files.
               .p4bin  : Invokes NCC for all the P4 files in the MODULE_DIR
               .asmbin : Invokes CAPAS for all the '.asm' or '.s' files in the MODULE_DIR
               .gobin  : Invokes gobuild for the MODULE_DIR prefixed with GOPATH

MODULE_SRCS: Source files used to build the target. 
             Source files are selected based on the target extension. 
             Note that all the source files from the MODULE_DIR will be 
             selected for compilation. If user wants to override this, 
             he can explicitly specify the list of source files with 
             full path from TOPDIR.
             E.g. MODULE_SRCS    := ${MODULE_SRC_DIR}/foo.cc \
                                    nic/xyz/bar.cc

MODULE_GENTYPES: Used to control generation types. 
                 Currently used for PROTO to PY/CC code generation.

MODULE_POSTGEN_MK: This is for 2nd phase make. If the source files for a 
                   target are generated by another target, then this varible 
                   must be set as below.

                   E.g. Target1 generates source files a.cc ...... z.cc
                        Target2 builds a library from all the .cc files 
                        generated by target1.
                
                  In this case, the source file list is not available for 
                  make until Target1 is complete. Hence a 2 phase make is 
                  used. Target1 'module.mk' file specifies Target2's 'mk' 
                  file in MODULE_POSTGEN_MK. After target1 is build, make 
                  will read Target2's 'module.mk' again to derive the source 
                  file list and build it.
                  Refer to Proto or P4 module.mk files for usage.

MODULE_DEPS: Dependencies for this target. These are not other targets, they 
             must be regular files. For expressing dependencies on other 
             targets use MODULE_PREREQS.

MODULES_PREREQS: This specifies the list of module.mk targets that need to be 
                 build as a pre-requisite to building this target. The main 
                 difference between this and MODULE_DEPS is that, MODULE_DEPS 
                 are regular files. The infra does not evaluate them in an 
                 special way, whereas MODULE_PREREQS are the 'MODULE_TARGET' 
                 values used in other module.mk files.

MODULE_LIBS: List of **system** libraries to link with.
             E.g. MODULE_LIBS := pthread 
                  provides the behavior of '-lpthread' to linker.
             These can be .so or .a libraries and they will be picked based
             on linker defaults.

MODULE_SOLIBS: List of **shared** libraries to link with.
               These libraries(targets) are known-to/built-by this make infra, 
               i.e there is a 'module.mk' somewhere in the repo with this 
               library as a MODULE_TARGET. They automatically become 
               pre-requisites of this target. There is no need to explicitly 
               add them as pre-requisites.

MODULE_ARLIBS: List of **archive** libraries to link with.
               These libraries(targets) are known-to/built-by this make infra, 
               i.e there is a 'module.mk' somewhere in the repo with this 
               library as a MODULE_TARGET. They automatically become 
               pre-requisites of this target. There is no need to explicitly 
               add them as pre-requisites.

MODULE_INCS: List of additional include paths required for the compilation 
             of this target. By default following paths are automatically
             added to the include paths.
             - /sw/nic/
             - /sw/nic/sdk/
             - /sw/nic/build/${ARCH}/${PIPELINE}/  (For generated headers)

             Note: It is recommended that all includes in the code are from
                   the TOPDIR (/sw). This helps code readability and prevents
                   include path explosion in the compilation command.

MODULE_LDPATHS: List of additional library paths required for linking. By 
                default all libraries built and exported by this infra are
                symlinked in '/sw/nic/build/${ARCH}/${PIPELINE}/lib' and 
                this path is automatically added as a '-L<path>' to the 
                linker.

MODULE_DEFS: List of defines required by this target. They will translated
             to '-D<def>' for gcc/g++ targets.

MODULE_PIPELINE: Restricts the target to a specific pipeline. By default,
                 when not specified, target is built for all pipelines.

MODULE_ARCH: Restricts the target to a specific ARCH. By default, when not
             specified, target is built for all architectures.
             Supported architectures are 'x86_64' and 'aarch64'

MODULE_FLAGS: Any other flag to be passed for building this flag.


3.0 Build Commands for the new make infra:
==========================================

Build Simulation(x86_64) Image (IRIS) (No Change) :
----------------------------------------------------
Old     : make
New     : make

Outputs : nic.tar / nic.tgz (Equivalent to 'make package-sim' in old-infra.)

Build Hardware (aarch64) Image (IRIS):
-----------------------------------------
Old     : make ARCH=aarch64 -C hal/iris haps
New     : make ARCH=aarch64

Outputs : nic.tar / nic.tgz (Equivalent to 'make package' in old-infra.)

Build GFT Image:
----------------------------------------------------
Old     : make gft
New     : make PIPELINE=gft

Outputs : GFT build artifacts.

Build Apollo Image:
----------------------------------------------------
Old     : make apollo
New     : make PIPELINE=apollo

Docker Targets: (Add 'docker/' to all docker targets)
------------------------------------------------------
Old     : make shell
New     : make docker/shell

.job.yml Changes:
-------------------
All targets moved sw/nic/mkdefs/jobd_targets.mk
run.py will automatically collect all logs and cores.
Usage: JOB_ID=1 make jobd/dol/parser

Building Individual Targets:
-----------------------------
Look for module_*.mk in your module directory.
MODULE_TARGET is the target name.
e.g. make hal.bin
