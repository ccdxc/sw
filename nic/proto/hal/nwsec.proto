//------------------------------------------------------------------------------
// {C} Copyright 2017 Pensando Systems Inc. All rights reserved
//
// protobuf specification for network security objects
//------------------------------------------------------------------------------

syntax = "proto3";

import "types.proto";
import "kh.proto";
import "delphi.proto";

package nwsec;
option go_package="halproto";

service NwSecurity {
  rpc SecurityProfileCreate (SecurityProfileRequestMsg) returns (SecurityProfileResponseMsg) {}
  rpc SecurityProfileUpdate (SecurityProfileRequestMsg) returns (SecurityProfileResponseMsg) {}
  rpc SecurityProfileDelete (SecurityProfileDeleteRequestMsg) returns (SecurityProfileDeleteResponseMsg) {}
  rpc SecurityProfileGet (SecurityProfileGetRequestMsg) returns (SecurityProfileGetResponseMsg) {}

  rpc SecurityGroupPolicyCreate (SecurityGroupPolicyRequestMsg) returns (SecurityGroupPolicyResponseMsg) {}
  rpc SecurityGroupPolicyUpdate (SecurityGroupPolicyRequestMsg) returns (SecurityGroupPolicyResponseMsg) {}
  rpc SecurityGroupPolicyDelete (SecurityGroupPolicyDeleteRequestMsg) returns (SecurityGroupPolicyDeleteResponseMsg) {}
  rpc SecurityGroupPolicyGet (SecurityGroupPolicyGetRequestMsg) returns (SecurityGroupPolicyGetResponseMsg) {}

  rpc SecurityGroupCreate (SecurityGroupRequestMsg) returns (SecurityGroupResponseMsg) {}
  rpc SecurityGroupUpdate (SecurityGroupRequestMsg) returns (SecurityGroupResponseMsg) {}
  rpc SecurityGroupDelete (SecurityGroupDeleteRequestMsg) returns (SecurityGroupDeleteResponseMsg) {}
  rpc SecurityGroupGet (SecurityGroupGetRequestMsg) returns (SecurityGroupGetResponseMsg) {}

  rpc SecurityPolicyCreate (SecurityPolicyRequestMsg) returns (SecurityPolicyResponseMsg) {}
  rpc SecurityPolicyUpdate (SecurityPolicyRequestMsg) returns (SecurityPolicyResponseMsg) {}
  rpc SecurityPolicyDelete (SecurityPolicyDeleteRequestMsg) returns (SecurityPolicyDeleteResponseMsg) {}
  rpc SecurityPolicyGet (SecurityPolicyGetRequestMsg) returns (SecurityPolicyGetResponseMsg) {}

  rpc SecurityFlowGateGet (SecurityFlowGateGetRequestMsg) returns (SecurityFlowGateGetResponseMsg) {}
  rpc SecurityFlowGateDelete (SecurityFlowGateDeleteRequestMsg) returns (SecurityFlowGateDeleteResponseMsg) {}
}

// normalization feature actions upon detecting malformed packets
enum NormalizationAction {
  NORM_ACTION_NONE    = 0;
  NORM_ACTION_ALLOW   = 1;    // allow the packet as is
  NORM_ACTION_DROP    = 2;    // drop the packet
  NORM_ACTION_EDIT    = 3;    // reset/trim/fix invalid fields/flags
}


//------------------------------------------------------------------------------
// SecurityProfileSpec object captures feature knobs that are most likely
// shareable across L2 segments, vrfs, or even interfaces and most of the
// time operates on defaults. It is possible that there is only object of this
// kind in the system.
// NOTE: user is not expected to fill in all the fields explicitly, that job is
//       done by the agent. Agent will be exposing user visible knobs and fill
//       in the defaults when interacting with HAL.
//
// Expected defaults:
//
// 1. Any abnormal behavior w.r.t flags (IP or TCP), default action is drop
// 2. Anything to do with options, default behavior is to reset/trim
// 3. Any length related errors, default is truncate the pkt
// 
// Semantics:
// tcp_cnxn_setup_timeout = Maximum time elapsed from first SYN to 3-way handshake completion. 
//                          Session gets cleaned up if 3-way handshake is not done by
//                          this time.
// tcp_half_closed_timeout= Maximum time elapsed from first FIN to 3/4way close.
//                           Session gets cleaned up if this elapses. To support half-open
//                           connections, this needs to be configured with a high value.
// tcp_close_timeout      = Time wait after FIN/RST is seen from both sides to session cleanup.
//
// tcp/udp/icmp_timeout   = Maximum idle timeout allowed for tcp/upd/icmp sessions before they
//                           are aged out. For TCP sessions, 3 TCP tickles are sent with 3 seconds
//                           interval. If we dont see a response back, we age out the session after 
//                           sending out TCP RST.
// session_idle_timeout   = Maximum idle timeout allowed for all other sessions.
//                            
//
// {
//     cnxn_tracking_en                    = true
//     tcp_non_syn_first_pkt_drop          = true
//
//     ip_normalization_en                 = true
//     {
//         ip_ttl_change_detect_en         = false
//         ip_rsvd_flags_action            = drop
//         ip_df_action                    = allow
//         ip_options_action               = allow
//         ip_invalid_len_action           = trim
//         ip_normalize_ttl                = 0 (applicable only for workload
//                                              generated traffic)
//     }
//
//     icmp_normalization_en               = true
//     {
//         icmp_invalid_code_action        = drop
//         icmp_deprecated_msgs_drop       = true
//         icmp_redirect_msg_drop          = true
//     }
//
//     tcp_normalization_en                = true
//     {
//         tcp_split_handshake_drop        = false
//         tcp_rsvd_flags_action           = drop
//         tcp_unexpected_mss_action       = strip
//         tcp_unexpected_win_scale_action = strip
//         tcp_urg_ptr_not_set_action      = reset
//         tcp_urg_flag_not_set_action     = reset
//         tcp_urg_payload_missing_action  = reset
//         tcp_rst_with_data_action        = drop
//         tcp_data_len_gt_mss_action      = trim  (if conntrack is enabled)
//         tcp_data_len_gt_win_size_action = trim  (if conntrack is enabled)
//         tcp_unexpected_ts_option_action = reset (if conntrack is enabled)
//         tcp_unexpected_echo_ts_action   = drop
//         tcp_ts_not_present_drop         = true  (if conntrack is enabled)
//         tcp_invalid_flags_drop          = true
//         tcp_nonsyn_noack_drop           = true
//         tcp_normalize_mss               = 0 (no tcp_mss normalization)
//     }
//
//
// Flood protection knobs.
// Default is 0 and max is 128K sessions cumulative across all types.
//
//     tcp_half_open_session_limit         = 0 (no limits applied)
//     udp_active_session_limit            = 0 (no limits applied)
//     icmp_active_session_limit           = 0 (no limits applied)
//     other_active_session_limit          = 0 (no limits applied)
//
// }
//------------------------------------------------------------------------------
message SecurityProfileSpec {
  kh.SecurityProfileKeyHandle  key_or_handle                      = 1 [(gogoproto.moretags) = "venice:key"];

  uint32                       session_idle_timeout               = 2 [(gogoproto.moretags) = "range:30-172800, venice:default=90"];
  uint32                       tcp_cnxn_setup_timeout             = 3 [(gogoproto.moretags) = "range:1-60, venice:default=30"];
  uint32                       tcp_close_timeout                  = 4 [(gogoproto.moretags) = "range:1-300, venice:default=15"];
  uint32                       tcp_half_closed_timeout            = 5 [(gogoproto.moretags) = "range:1-172800, venice:default=120"];
  uint32                       ip_normalize_ttl                   = 6 [(gogoproto.moretags) = "range:0-255, venice:default=0"];
  uint32                       tcp_drop_timeout                   = 7 [(gogoproto.moretags) = "range:1-300, venice:default=90"];
  uint32                       udp_drop_timeout                   = 8 [(gogoproto.moretags) = "range:1-172800, venice:default=60"];
  uint32                       icmp_drop_timeout                  = 9 [(gogoproto.moretags) = "range:1-300, venice:default=60"];
  uint32                       drop_timeout                       = 10 [(gogoproto.moretags) = "range:1-300, venice:default=60"];
  uint32                       tcp_timeout                        = 11 [(gogoproto.moretags) = "range:1-172800, venice:default=3600"];
  uint32                       udp_timeout                        = 12 [(gogoproto.moretags) = "range:1-172800, venice:default=30"];
  uint32                       icmp_timeout                       = 13 [(gogoproto.moretags) = "range:1-172800, venice:default=6"];

  bool                         cnxn_tracking_en                   = 14 [(gogoproto.moretags) = "venice:default=true"];
  bool                         ipsg_en                            = 15 [(gogoproto.moretags) = "venice:default=false"];
  bool                         tcp_rtt_estimate_en                = 16 [(gogoproto.moretags) = "venice:default=false"];
  bool                         ip_normalization_en                = 17 [(gogoproto.moretags) = "venice:default=true"];
  bool                         tcp_normalization_en               = 18 [(gogoproto.moretags) = "venice:default=true"];
  bool                         icmp_normalization_en              = 19 [(gogoproto.moretags) = "venice:default=true"];
  bool                         ip_reassembly_en                   = 20 [(gogoproto.moretags) = "venice:default=false"];

  // IP normalization knobs
  bool                         ip_ttl_change_detect_en            = 21 [(gogoproto.moretags) = "venice:default=false"];
  bool                         ip_src_guard_en                    = 22 [(gogoproto.moretags) = "venice:default=false"];
  NormalizationAction          ip_rsvd_flags_action               = 23 [(gogoproto.moretags) = "venice:default=nwsec.NormalizationAction.NORM_ACTION_DROP"];
  NormalizationAction          ip_df_action                       = 24 [(gogoproto.moretags) = "venice:default=nwsec.NormalizationAction.NORM_ACTION_ALLOW"];
  NormalizationAction          ip_options_action                  = 25 [(gogoproto.moretags) = "venice:default=nwsec.NormalizationAction.NORM_ACTION_ALLOW"];
  NormalizationAction          ip_invalid_len_action              = 26 [(gogoproto.moretags) = "venice:default=nwsec.NormalizationAction.NORM_ACTION_TRIM"];
  bool                         ip_spoof_pkt_drop                  = 27 [(gogoproto.moretags) = "venice:default=false"];
  bool                         ip_loose_src_routing_pkt_drop      = 28 [(gogoproto.moretags) = "venice:default=false"];
  bool                         ip_malformed_option_pkt_drop       = 29 [(gogoproto.moretags) = "venice:default=false"];
  bool                         ip_record_route_option_pkt_drop    = 30 [(gogoproto.moretags) = "venice:default=false"];
  bool                         ip_strict_src_routing_pkt_drop     = 31 [(gogoproto.moretags) = "venice:default=false"];
  bool                         ip_ts_option_pkt_drop              = 32 [(gogoproto.moretags) = "venice:default=false"];
  bool                         ip_unknown_option_pkt_drop         = 33 [(gogoproto.moretags) = "venice:default=false"];
  bool                         ip_stream_id_option_pkt_drop       = 34 [(gogoproto.moretags) = "venice:default=false"];
  bool                         ip_rsvd_fld_set_pkt_drop           = 35 [(gogoproto.moretags) = "venice:default=false"];
  bool                         ip_clear_df_bit                    = 36 [(gogoproto.moretags) = "venice:default=false"];

  // IPv6 knobs
  bool                         ipv6_anycast_src_drop              = 40 [(gogoproto.moretags) = "venice:default=false"];;
  bool                         ipv6_v4_compatible_addr_drop       = 41 [(gogoproto.moretags) = "venice:default=false"];;
  bool                         ipv6_needless_ip_frag_hdr_drop     = 42 [(gogoproto.moretags) = "venice:default=false"];;
  bool                         ipv6_invalid_options_pkt_drop      = 43 [(gogoproto.moretags) = "venice:default=false"];;
  bool                         ipv6_rsvd_fld_set_pkt_drop         = 44 [(gogoproto.moretags) = "venice:default=false"];;
  bool                         ipv6_rtg_hdr_pkt_drop              = 45 [(gogoproto.moretags) = "venice:default=false"];;
  bool                         ipv6_dst_options_hdr_pkt_drop      = 46 [(gogoproto.moretags) = "venice:default=false"];;
  bool                         ipv6_hop_by_hop_options_pkt_drop   = 47 [(gogoproto.moretags) = "venice:default=false"];;


  // ICMP/ICMPv6 normalization knobs
  NormalizationAction          icmp_invalid_code_action           = 50 [(gogoproto.moretags) = "venice:default=nwsec.NormalizationAction.NORM_ACTION_DROP"];
  bool                         icmp_deprecated_msgs_drop          = 51 [(gogoproto.moretags) = "venice:default=true"];
  bool                         icmp_redirect_msg_drop             = 52 [(gogoproto.moretags) = "venice:default=true"];
  bool                         icmp_dst_unreach_ignore_payload    = 53 [(gogoproto.moretags) = "venice:default=false"];
  bool                         icmp_param_prblm_ignore_payload    = 54 [(gogoproto.moretags) = "venice:default=false"];
  bool                         icmp_pkt_too_big_ignore_payload    = 55 [(gogoproto.moretags) = "venice:default=false"];
  bool                         icmp_redirect_ignore_payload       = 56 [(gogoproto.moretags) = "venice:default=false"];
  bool                         icmp_time_exceed_ignore_payload    = 57 [(gogoproto.moretags) = "venice:default=false"];
  bool                         icmp_error_drop                    = 58 [(gogoproto.moretags) = "venice:default=false"];
  bool                         icmp_fragments_drop                = 59 [(gogoproto.moretags) = "venice:default=false"];
  bool                         icmp_large_pkt_drop                = 60 [(gogoproto.moretags) = "venice:default=false"];
  bool                         icmp_ping_zero_id_drop             = 61 [(gogoproto.moretags) = "venice:default=false"];
  bool                         icmp_need_frag_suppress            = 62 [(gogoproto.moretags) = "venice:default=false"];
  bool                         icmp_time_exceed_suppress          = 63 [(gogoproto.moretags) = "venice:default=false"];
  bool                         icmpv6_large_msg_mtu_small_drop    = 64 [(gogoproto.moretags) = "venice:default=false"];


  // TCP normalization knobs
  bool                         tcp_split_handshake_drop           = 71 [(gogoproto.moretags) = "venice:default=false"];
  NormalizationAction          tcp_rsvd_flags_action              = 72 [(gogoproto.moretags) = "venice:default=nwsec.NormalizationAction.NORM_ACTION_DROP"];
  NormalizationAction          tcp_unexpected_mss_action          = 73 [(gogoproto.moretags) = "venice:default=nwsec.NormalizationAction.NORM_ACTION_STRIP"];
  NormalizationAction          tcp_unexpected_win_scale_action    = 74 [(gogoproto.moretags) = "venice:default=nwsec.NormalizationAction.NORM_ACTION_STRIP"];
  NormalizationAction          tcp_unexpected_sack_perm_action    = 75 [(gogoproto.moretags) = "venice:default=nwsec.NormalizationAction.NORM_ACTION_STRIP"];
  NormalizationAction          tcp_urg_ptr_not_set_action         = 76 [(gogoproto.moretags) = "venice:default=nwsec.NormalizationAction.NORM_ACTION_RESET"];
  NormalizationAction          tcp_urg_flag_not_set_action        = 77 [(gogoproto.moretags) = "venice:default=nwsec.NormalizationAction.NORM_ACTION_RESET"];
  NormalizationAction          tcp_urg_payload_missing_action     = 78 [(gogoproto.moretags) = "venice:default=nwsec.NormalizationAction.NORM_ACTION_RESET"];
  NormalizationAction          tcp_rst_with_data_action           = 79 [(gogoproto.moretags) = "venice:default=nwsec.NormalizationAction.NORM_ACTION_DROP"];
  NormalizationAction          tcp_data_len_gt_mss_action         = 80 [(gogoproto.moretags) = "venice:default=nwsec.NormalizationAction.NORM_ACTION_TRIM"];
  NormalizationAction          tcp_data_len_gt_win_size_action    = 81 [(gogoproto.moretags) = "venice:default=nwsec.NormalizationAction.NORM_ACTION_TRIM"];
  NormalizationAction          tcp_unexpected_ts_option_action    = 82 [(gogoproto.moretags) = "venice:default=nwsec.NormalizationAction.NORM_ACTION_RESET"];
  NormalizationAction          tcp_unexpected_echo_ts_action      = 83 [(gogoproto.moretags) = "venice:default=nwsec.NormalizationAction.NORM_ACTION_DROP"];
  NormalizationAction          tcp_unexpected_sack_option_action  = 84 [(gogoproto.moretags) = "venice:default=nwsec.NormalizationAction.NORM_ACTION_DROP"];
  bool                         tcp_ts_not_present_drop            = 85 [(gogoproto.moretags) = "venice:default=true"];
  bool                         tcp_non_syn_first_pkt_drop         = 86 [(gogoproto.moretags)="venice:default=true"];

  // We will check for the following cases for invalid TCP flags
  // 1. SYN + FIN
  // 2. SYN + RST
  // 3. All TCP flags set (tcp_flags = 0xFF)
  // 4. No TCP flags set (tcp_flags = 0x0)
  bool                         tcp_invalid_flags_drop             = 87 [(gogoproto.moretags) = "venice:default=true"];
  bool                         tcp_nonsyn_noack_drop              = 88 [(gogoproto.moretags) = "venice:default=true"];
  bool                         tcp_syn_with_data_drop             = 89 [(gogoproto.moretags) = "venice:default=false"];
  bool                         tcp_syn_ack_with_data_drop         = 90 [(gogoproto.moretags) = "venice:default=false"];
  bool                         tcp_overlapping_segments_drop      = 91 [(gogoproto.moretags) = "venice:default=false"];
  bool                         tcp_strip_timestamp_option         = 92 [(gogoproto.moretags) = "venice:default=false"];
  bool                         tcp_conn_track_bypass_window_err   = 93 [(gogoproto.moretags) = "venice:default=false"];
  bool                         tcp_conn_track_fin_rst_disable     = 94 [(gogoproto.moretags) = "venice:default=false"];
  bool                         tcp_urg_flag_ptr_clear             = 95 [(gogoproto.moretags) = "venice:default=false"];
  // Can we have zero as default but when configured the range is between 576 - 9216 ?
  uint32                       tcp_normalize_mss                  = 96 [(gogoproto.moretags) = "range:0-9216, venice:default=0"];
  bool                         multicast_src_drop                 = 97 [(gogoproto.moretags) = "venice:default=true"];

  // Flood protection knobs
  uint32                       tcp_half_open_session_limit        = 98 [(gogoproto.moretags) = "range:0-128000, venice:default=0"];
  uint32                       udp_active_session_limit           = 99 [(gogoproto.moretags) = "range:0-128000, venice:default=0"];
  uint32                       icmp_active_session_limit          = 100 [(gogoproto.moretags) = "range:0-128000, venice:default=0"];
  uint32                       other_active_session_limit         = 101 [(gogoproto.moretags) = "range:0-128000, venice:default=0"];

  // Firewall knobs
  bool                         policy_enforce_en                  = 102 [(gogoproto.moretags) = "venice:default=false"];;
  bool                         flow_learn_en                      = 103 [(gogoproto.moretags) = "venice:default=false"];;
}

// Applicaion Layer Gateway (ALG) names for invoking appropriate ALG
enum ALGName {
  APP_SVC_NONE        = 0;
  APP_SVC_TFTP        = 1;    // Trivial File Transfer Protocol
  APP_SVC_FTP         = 2;    // File Transfer Protocol
  APP_SVC_DNS         = 3;    // Domain Name System
  APP_SVC_SIP         = 4;    // Session Initiation Protocol
  APP_SVC_SUN_RPC     = 5;    // SUN Remote Procedure Call
  APP_SVC_MSFT_RPC    = 6;    // Microsoft Remote Procedure Call
  APP_SVC_RTSP        = 7;    // Real-Time Streaming Protocol
  APP_SVC_TRACEROUTE  = 8;    // TRACEROUTE ALG
  APP_SVC_IP          = 9;    // IP ALG (uni-directional flow per session)
  APP_SVC_ANY         = 10;   // "any" app
}

// SecurityProfileRequestMsg is batched add or modify profile request
message SecurityProfileRequestMsg {
  repeated SecurityProfileSpec    request = 1;    // batched request
}

// Security profile oper state for enterprise pipeline
message SecurityProfileStatusEpd {
    uint32  hw_sec_profile_id       = 1;    // security profile hw table index
}

// Security profile oper state for cloud pipeline
message SecurityProfileStatusCpd {
}

// SecurityProfile operational status
message SecurityProfileStatus {
  fixed64    profile_handle                 = 1;    // id of the security profile returned by HAL
  oneof profile_pd_status {
      SecurityProfileStatusEpd  epd_status  = 2;    // Security Profile oper state for enterprise pipeline
      SecurityProfileStatusCpd  cpd_status  = 3;    // Security Profile oper state for cloud pipeline
  }
}

// SecurityProfileResponse is response to SecurityProfileSpec
message SecurityProfileResponse {
  types.ApiStatus          api_status     = 1	[(gogoproto.moretags) = "venice:api_status"]; // API status code
  SecurityProfileStatus    profile_status = 2;    // SecurityProfile profile operational status
}

// SecurityProfileResponseMsg is batched response to SecurityProfileRequestMsg
message SecurityProfileResponseMsg {
  repeated SecurityProfileResponse    response = 1;    // batched response
}

// SecurityProfileDeleteRequest is used to delete a SecurityProfile profile
message SecurityProfileDeleteRequest {
  // key_or_handle is to identify SecurityProfile being deleted
  kh.SecurityProfileKeyHandle key_or_handle = 1 [(gogoproto.moretags) = "venice:key"];
}

// SecurityProfileDeleteRequestMsg is used to delete a batch of SecurityProfile profiles
message SecurityProfileDeleteRequestMsg {
  repeated SecurityProfileDeleteRequest request = 1;    // batched delete request
}

// SecurityProfileResponse is response to SecurityProfileSpec
message SecurityProfileDeleteResponse {
  types.ApiStatus          api_status     = 1 [(gogoproto.moretags) = "venice:api_status"]; // API status code
  SecurityProfileStatus    profile_status = 2;    // SecurityProfile profile operational status
}

// SecurityProfileDeleteResponseMsg is batched response to SecurityProfileDeleteRequestMsg
message SecurityProfileDeleteResponseMsg {
  repeated SecurityProfileDeleteResponse    response = 1;    // batched response
}

// SecurityProfileGetRequest is used to get information about a L2 Segment
message SecurityProfileGetRequest {
  // key_or_handle is the security profile's identifier for retrieval
  kh.SecurityProfileKeyHandle key_or_handle  = 1 [(gogoproto.moretags) = "venice:key"];
}

// SecurityProfileGetRequestMsg is batched GET request for SecurityProfile profiles
message SecurityProfileGetRequestMsg {
  repeated SecurityProfileGetRequest    request = 1;    // batched get request
}

// SecurityProfileStats is the statistics object for each SecurityProfile profile
message SecurityProfileStats {
}

// SecurityProfileGetResponse captures all the information about a SecurityProfile profile
message SecurityProfileGetResponse {
  types.ApiStatus          api_status = 1    [(gogoproto.moretags) = "venice:api_status"];// API status code
  SecurityProfileSpec      spec       = 2;    // config spec
  SecurityProfileStatus    status     = 3;    // operational status
  SecurityProfileStats     stats      = 4;    // stats, if any
}

// SecurityProfileGetResponseMsg is the batched response to SecurityProfileGetRequestMsg
message SecurityProfileGetResponseMsg {
  repeated SecurityProfileGetResponse     response   = 1;    // batched get response
}

// Firewall policy actions
enum FirewallAction {
  FIREWALL_ACTION_NONE   = 0;
  FIREWALL_ACTION_ALLOW  = 1;
  FIREWALL_ACTION_DENY   = 2;
  FIREWALL_ACTION_REJECT = 3;
}

// Service object identifies an app defined by IP protocol and TCP/UDP port
// in most cases. This object also can specify blanket apps like all TCP or
// UDP traffic, all IP traffic, ICMP type/code combinations etc.
message Service {
  types.IPProtocol           ip_protocol     = 1;    // IP protocol
  oneof l4_info {
    uint32                   dst_port        = 2;    // TCP or UDP port,
    types.ICMPMsgType        icmp_msg_type   = 3;
  }
  ALGName                    alg             = 4;                //  Identifies ALG name
}

// FirewallRuleSpec defines a stateful firewall rule that is part of a
// SecurityGroupSpec
message FirewallRuleSpec {
  repeated  Service   svc                = 2;    // application service
  repeated  string    apps               = 3;    // For appid based policy enforcement
  FirewallAction      action             = 4;    // action to take
  bool                log                = 5;    // log if this rule is hit
}

// ingress policy for the security group
message NetworkSecurityPolicy {
  repeated FirewallRuleSpec    in_fw_rules       = 1;    // ingress firewall rules
  repeated FirewallRuleSpec    eg_fw_rules       = 2;    // egress firewall rules
}

// egress policy for the security group
//message EgressNetworkSecurityPolicy {
 //repeated FirewallRuleSpec    fw_rules       = 1;    // egress firewall rules
//}


// SecurityGroupPolicySpec captures the policy for a security group pair (aka. group of
// endpoints or enic interfaces) in both directions from workload's perspective.
// This policy will be attached to enic interface or an endpoint so it applies
// to the traffic from/to that workload. If no match is found for the new
// session in the slow path, either a drop flow will be installed or packet will
// be dropped without creating drop flow
message SecurityGroupPolicySpec {
  // key_or_handle is the security group's unique identifier
  kh.SecurityGroupPolicyKeyHandle key_or_handle  = 1 [(gogoproto.moretags) = "venice:key"];
  NetworkSecurityPolicy                        policy_rules   = 2;    // ingress policy
}

// SecurityGroupPolicyRequestMsg is batched add or modify security group policy request
message SecurityGroupPolicyRequestMsg {
  repeated SecurityGroupPolicySpec    request = 1;    // batched request
}

// security group operational status
message SecurityGroupPolicyStatus {
  fixed64    policy_handle = 1;    // id of the security group returned by HAL
}

// SecurityGroupResponse is the response to SecurityGroupPolicySpec
message SecurityGroupPolicyResponse {
  types.ApiStatus              api_status  = 1 [(gogoproto.moretags) = "venice:api_status"];    // API status code
  SecurityGroupPolicyStatus    status      = 2;    // operational status
}

// SecurityGroupResponseMsg is batched response to SecurityGroupPolicyRequestMsg
message SecurityGroupPolicyResponseMsg {
  repeated SecurityGroupPolicyResponse    response = 1;    // batched response
}

// SecurityGroupPolicyDeleteRequest is used to delete a security group policy
message SecurityGroupPolicyDeleteRequest {
  // key_or_handle is the security group's unique identifier
  kh.SecurityGroupPolicyKeyHandle key_or_handle  = 1 [(gogoproto.moretags) = "venice:key"];
}

// SecurityGroupDeleteRequestMsg is used to delete a batch of security group policies.
message SecurityGroupPolicyDeleteRequestMsg {
  repeated SecurityGroupPolicyDeleteRequest    request = 1;
}

message SecurityGroupPolicyDeleteResponse {
  types.ApiStatus    api_status = 1 [(gogoproto.moretags) = "venice:api_status"];    // API status code
}
// SecurityGroupPolicyDeleteResponseMsg is batched response to
// SecurityGroupPolicyDeleteRequestMsg
message SecurityGroupPolicyDeleteResponseMsg {
  repeated SecurityGroupPolicyDeleteResponse response = 1;    // API status code
}

// SecurityGroupPolicyGetRequest is used to get information about a security group policy
message SecurityGroupPolicyGetRequest {
  // key_or_handle is the security group's unique identifier
  kh.SecurityGroupPolicyKeyHandle key_or_handle  = 1 [(gogoproto.moretags) = "venice:key"];
}

// SecurityGroupGetRequestMsg is batched GET request for security group policies
message SecurityGroupPolicyGetRequestMsg {
  repeated SecurityGroupPolicyGetRequest    request = 1;    // batched get request
}


// SecurityGroupStats is the statistics object for a security group
message SecurityGroupPolicyStats {
}

// SecurityGroupGetResponse captures all the information about a security group
message SecurityGroupPolicyGetResponse {
  types.ApiStatus              api_status = 1 [(gogoproto.moretags) = "venice:api_status"];    // API status code
  SecurityGroupPolicySpec      spec       = 2;    // configuration of security policy
  SecurityGroupPolicyStatus    status     = 3;    // operational state of security policy
  SecurityGroupPolicyStats     stats      = 4;    // debug status of security policy
}

// SecurityGroupPolicyGetResponseMsg is batched response to SecurityGroupGetRequestMsg
message SecurityGroupPolicyGetResponseMsg {
  repeated SecurityGroupPolicyGetResponse    response   = 1;    // batched get response
  types.ApiStatus                            api_status = 2;    // Batch API Statu code
}

message SecurityGroupSpec {
  option (delphi.update_event) = true;
  delphi.ObjectMeta          Meta          = 1;

  // key_or_handle is the security group's unique identifier
  kh.SecurityGroupKeyHandle  key_or_handle = 2 [(gogoproto.moretags) = "venice:key"];
}

// SecurityGroupRequestMsg is batched add or modify security group policy request
message SecurityGroupRequestMsg {
  repeated SecurityGroupSpec    request = 1;    // batched request
}

// security group operational status
message SecurityGroupStatus {
  option (delphi.update_event) = true;
  delphi.ObjectMeta          Meta          = 1;

  kh.SecurityGroupKeyHandle  key_or_handle = 2 [(gogoproto.moretags) = "venice:key"];
}

// SecurityGroupResponse is the response to SecurityGroupSpec
message SecurityGroupResponse {
  types.ApiStatus        api_status  = 1 [(gogoproto.moretags) = "venice:api_status"];    // API status code
  SecurityGroupStatus    status      = 2;    // operational status
}

// SecurityGroupResponseMsg is batched response to SecurityGroupRequestMsg
message SecurityGroupResponseMsg {
  repeated SecurityGroupResponse    response = 1;    // batched response
}

// SecurityGroupDeleteRequest is used to delete a security group
message SecurityGroupDeleteRequest {
  // key_or_handle is the security group's unique identifier
  kh.SecurityGroupKeyHandle key_or_handle  = 1 [(gogoproto.moretags) = "venice:key"];
}

// SecurityGroupDeleteRequestMsg is used to delete a batch of security groups
message SecurityGroupDeleteRequestMsg {
  repeated SecurityGroupDeleteRequest    request = 1;
}

// SecurityGroupDeleteResponseMsg is batched response to
// SecurityGroupDeleteRequestMsg
message SecurityGroupDeleteResponseMsg {
  repeated types.ApiStatus    api_status = 1 [(gogoproto.moretags) = "venice:api_status"];    // API status code
}

// SecurityGroupGetRequest is used to get information about a security group
message SecurityGroupGetRequest {
  // key_or_handle is the security group's unique identifier
  kh.SecurityGroupKeyHandle key_or_handle  = 1 [(gogoproto.moretags) = "venice:key"];
}

// SecurityGroupGetRequestMsg is batched GET request for security groups
message SecurityGroupGetRequestMsg {
  repeated SecurityGroupGetRequest    request = 1;    // batched get request
}

// SecurityGroupStats is the statistics object for a security group
message SecurityGroupStats {
}

// SecurityGroupGetResponse captures all the information about a security group
message SecurityGroupGetResponse {
  types.ApiStatus        api_status = 1 [(gogoproto.moretags) = "venice:api_status"];    // API status code
  SecurityGroupSpec      spec       = 2;    // configuration of security group
  SecurityGroupStatus    status     = 3;    // operational state of security group
  SecurityGroupStats     stats      = 4;    // debug status of security group
}

// SecurityGroupGetResponseMsg is batched response to SecurityGroupGetRequestMsg
message SecurityGroupGetResponseMsg {
  repeated SecurityGroupGetResponse    response   = 1;    // batched get response
  types.ApiStatus                      api_status = 2;    // batch status
}

// AppData- identifies app data specific to security plugin
message AppData {
  ALGName           alg                  = 1;
  enum TraceLevel {
    TRACE_LEVEL_NONE      = 0;
    TRACE_LEVEL_BRIEF     = 1;
    TRACE_LEVEL_DETAIL    = 2;
    TRACE_LEVEL_EXTENSIVE = 3;
    TRACE_LEVEL_VERBOSE   = 4;
  }
  message TraceOptions {
    TraceLevel    level = 1;
  }
  message FTPOptions {
    bool allow_mismatch_ip_address  = 1; // pass FTP packets with mismatched IP header address and payload
  }
  message DNSOptions {
    bool      drop_multi_question_packets       = 1; // drop pkt if number of questions > 1
    bool      drop_large_domain_name_packets    = 2; // drop if domain name size is > 255 bytes
    bool      drop_long_label_packets           = 3; // drop if label length > 63
    bool      drop_multizone_packets            = 4; // (DDNS) drop if number of zones > 1
    uint32    max_msg_length                    = 5; // default 512 (max. 8192) bytes
    uint32    query_response_timeout            = 6; // default 60 secs
  }
  message RPCData {
    string program_id                    = 1;
    uint32 idle_timeout                  = 2;
  }
  message MSRPCOptions {
    repeated RPCData   data              = 1;
  }
  message SunRPCOptions {
    repeated RPCData   data              = 1;
  }
  message SIPOptions {
    uint32 ctimeout                      = 1;
    uint32 dscp_code_point               = 2;
    uint32 media_inactivity_timeout      = 3;
    uint32 max_call_duration             = 4;
    uint32 t1_timer_value                = 5;
    uint32 t4_timer_value                = 6;
  }
  oneof AppOptions {
    FTPOptions             ftp_option_info        = 2;
    DNSOptions             dns_option_info        = 3;
    MSRPCOptions           msrpc_option_info      = 4;
    SunRPCOptions          sun_rpc_option_info    = 5;
    SIPOptions             sip_options            = 6;
  }
  uint32            idle_timeout         = 7;
  TraceOptions      trace_opts           = 8;
}

// Action to be takn on hitting a rule
enum SecurityAction {
  SECURITY_RULE_ACTION_NONE   = 0;
  SECURITY_RULE_ACTION_ALLOW  = 1;
  SECURITY_RULE_ACTION_DENY   = 2;
  SECURITY_RULE_ACTION_REJECT = 3;
  SECURITY_RULE_ACTION_IMPLICIT_DENY = 4;
}

enum LogAction {
  LOG_NONE                     = 0;
  LOG_ON_SESSION_START         = 1;
  LOG_ON_SESSION_END           = 2;
  LOG_ON_SESSION_START_AND_END = 3;
}

message SecurityRuleAction {
  SecurityAction       sec_action = 1;  // Identifies the security action related to the rule
  LogAction            log_action = 2;  // Identifies log actions related to the rule
  AppData              app_data   = 3;  // Contains app related data - data for ALG.
}

message SecurityRule {
  uint64                          rule_id            = 1[(gogoproto.moretags) = "venice:mandatory"];      // Identifier supplied by agent
  types.RuleMatch                 match              = 2;      // match conditions
  SecurityRuleAction              action             = 3;      // action related to the rule
  repeated string                 appid              = 4;      // Future For appid based policy enforcment - can be moved into RuleMatch
}

// SecurityPolicySpec that contains set of SecurityRules
message SecurityPolicySpec {
  option (delphi.update_event) = true;
  delphi.ObjectMeta             Meta                   = 1;

  kh.SecurityPolicyKeyHandle    key_or_handle   = 2[(gogoproto.moretags) = "venice:key"];      // Policy Name that identifies the security Policy
  repeated SecurityRule         rule                   = 3;      // List of security rules
}

// SecurityPolicyRequestMsg is batched add or modify security policy request
message SecurityPolicyRequestMsg {
  repeated SecurityPolicySpec       request = 1;  //  batched request
}

message SecurityRuleStatus { 
  uint64          rule_id  = 1;  // Identifier supplied by agent
  uint64          priority = 2;  // Priority for the rule id
}

message SecurityPolicyStatus {
  option (delphi.update_event) = true;
  delphi.ObjectMeta             Meta                   = 1;

  kh.SecurityPolicyKeyHandle    key_or_handle   = 2[(gogoproto.moretags) = "venice:key"];      // Policy Name that identifies the security Policy
  repeated SecurityRuleStatus   rule_status     = 3; //Identifies rule and priority
}

// SecurityPolicyResponse is the response to SecurityPolicyRequest
message SecurityPolicyResponse {
  types.ApiStatus       api_status         = 1 [(gogoproto.moretags) = "venice:api_status"];  // API status code
  SecurityPolicyStatus  policy_status      = 2;  // operational status
}

message SecurityPolicyResponseMsg {
  repeated SecurityPolicyResponse response = 1;
}

// SecurityPolicyDeleteRequest is used to delete a security rule
message SecurityPolicyDeleteRequest {
  kh.SecurityPolicyKeyHandle      key_or_handle  = 1 [(gogoproto.moretags) = "venice:key"]; // policy_handle
}

// SecurityPolicyDeleteRequestMsg is used to delete a batch of security policy
message SecurityPolicyDeleteRequestMsg {
  repeated SecurityPolicyDeleteRequest  request = 1;
}

message SecurityPolicyDeleteResponse {
  types.ApiStatus api_status = 1 [(gogoproto.moretags) = "venice:api_status"]; // API status code
}

// SecurityPolicyDeleteResponseMsg is batched response to SecurityPolicyDeleteRequestMsg
message SecurityPolicyDeleteResponseMsg {
  repeated SecurityPolicyDeleteResponse response = 1;  // API status code
}

// SecurityPolicyGet is used to get information about a security policy
message SecurityPolicyGetRequest {
  // key_or_handle is the security policy's unique identifier
  kh.SecurityPolicyKeyHandle    key_or_handle = 1 [(gogoproto.moretags) = "venice:key"];
}

// SecurityPolicyGetRequestMsg is batched GET request for security policy
message SecurityPolicyGetRequestMsg {
  repeated SecurityPolicyGetRequest    request = 1; // batched get request
}

// SecurityRuleStats 
message SecurityRuleStats {
  uint64     rule_id               = 1;
  fixed64    num_hits              = 2;
  fixed64    num_tcp_hits          = 3;
  fixed64    num_udp_hits          = 4;
  fixed64    num_icmp_hits         = 5;  
}


// SecurityPolicyStats
message SecurityPolicyStats {
    repeated SecurityRuleStats  rule_stats = 1;  //repeated stats for rules
}


// only if api_status indicates success, other fields are valid
message SecurityPolicyGetResponse {
  types.ApiStatus                api_status  = 1 [(gogoproto.moretags) = "venice:api_status"]; // API status code
  SecurityPolicySpec             spec        = 2;  // SecurityPolicy configuration
  SecurityPolicyStatus           status      = 3;  // operational state of the security policy
  SecurityPolicyStats            pol_stats   = 4;  // stats for each rule
}

// SecurityPolicyGetResponse Msg is batched response to SecurityPolicyGetRequestMsg
message SecurityPolicyGetResponseMsg {
  repeated SecurityPolicyGetResponse   response   = 1;
}

message SecurityFlowGateFilter {
  types.IPAddress           src_ip          = 1;
  types.IPAddress           dst_ip          = 2;
  uint32                    src_port        = 3;
  uint32                    dst_port        = 4;
  types.IPProtocol          ip_proto        = 5;
  fixed64                   vrf_id          = 6;
  nwsec.ALGName             alg             = 7;
}

message SecurityFlowGateGetRequest {
  SecurityFlowGateFilter   filter  = 1; 
}

message SecurityFlowGateGetRequestMsg {
  repeated SecurityFlowGateGetRequest request = 1; //batched get request 
}

message FlowGateKey {
  types.FlowDirection        direction    = 1;
  fixed64                    src_vrf_id   = 2;
  fixed64                    dst_vrf_id   = 3;
  types.IPAddress            src_ip       = 4;
  types.IPAddress            dst_ip       = 5;
  types.IPProtocol           ip_proto     = 6;
  uint32                     src_port     = 7;   
  uint32                     dst_port     = 8;
}

message SecurityFlowGateGetResponse {
  types.ApiStatus             api_status    = 1 [(gogoproto.moretags) = "venice:api_status"];    // API status code
  FlowGateKey                 flow_gate_key = 2; // Flow key of the opened flow gate
  nwsec.ALGName               alg           = 3; // ALG applied to this app session
  bool                        delete_marked = 4; // Is flow gate marked for deletion ?
  uint32                      ref_count     = 5; // Number of references to this flow gate
  uint32                      time_to_age   = 6; // Time to age the entry
}

message SecurityFlowGateGetResponseMsg {
  types.ApiStatus                      api_status = 1; // API status
  repeated SecurityFlowGateGetResponse response   = 2; //batched response
}

message SecurityFlowGateDeleteRequest {
  SecurityFlowGateFilter   filter  = 1;
}

message SecurityFlowGateDeleteRequestMsg {
  repeated SecurityFlowGateDeleteRequest request = 1; //batched get request
}

message SecurityFlowGateDeleteResponseMsg {
}
